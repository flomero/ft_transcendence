<div class="container mt-4 form-container">
  <h1>Create New Game Lobby</h1>
  
  <form id="newLobbyForm" onsubmit="return handleFormSubmit(event)" data-spa-ignore="true">
    <!-- Basic Settings -->
    <div class="form-card">
      <div class="form-card-header">
        <h2 class="form-section-title mb-0">Basic Settings</h2>
      </div>
      <div class="form-card-body">
        <div class="form-row">
          <div class="form-col">
            <label for="gameName" class="form-label">Game</label>
            <select id="gameName" name="gameName" class="form-select" required>
              {{#each gameNames}}
                <option value="{{this}}">{{formatName this}}</option>
              {{/each}}
            </select>
          </div>
          
          <div class="form-col">
            <label for="gameModeName" class="form-label">Game Mode</label>
            <select id="gameModeName" name="gameModeName" class="form-select" required>
              {{#each gameModes}}
                <option value="{{this}}">{{formatName this}}</option>
              {{/each}}
            </select>
          </div>

          <div class="form-col">
            <label for="playerCount" class="form-label">Player Count</label>
            <div class="form-number-container">
              <input type="number" id="playerCount" name="playerCount" class="form-input" min="1" max="4" value="2" required>
            </div>
            <p class="form-help-text">Number of players in the game</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Mode Configuration -->
    <div class="form-card">
      <div class="form-card-header">
        <h2 class="form-section-title mb-0">Game Physics</h2>
      </div>
      <div class="form-card-body">
        <div class="form-row">
          <div class="form-col">
            <label for="ballSpeedWidthPercentS" class="form-label">Ball Speed (% width/s)</label>
            <div class="form-number-container">
              <input type="number" id="ballSpeedWidthPercentS" name="gameModeConfig.ballSpeedWidthPercentS" class="form-input" min="0" step="0.1" value="30">
            </div>
            <p class="form-help-text">How fast the ball moves across the arena</p>
          </div>
          
          <div class="form-col">
            <label for="ballRadius" class="form-label">Ball Radius</label>
            <div class="form-number-container">
              <input type="number" id="ballRadius" name="gameModeConfig.ballRadius" class="form-input" min="0" step="0.1" value="1">
            </div>
            <p class="form-help-text">Size of the ball</p>
          </div>
          
          <div class="form-col">
            <label for="paddleCoveragePercent" class="form-label">Paddle Coverage (%)</label>
            <div class="form-number-container">
              <input type="number" id="paddleCoveragePercent" name="gameModeConfig.paddleCoveragePercent" class="form-input" min="0" max="100" step="1" value="15">
            </div>
            <p class="form-help-text">Percentage of wall covered by paddle</p>
          </div>
          
          <div class="form-col">
            <label for="paddleSpeedWidthPercentS" class="form-label">Paddle Speed</label>
            <div class="form-number-container">
              <input type="number" id="paddleSpeedWidthPercentS" name="gameModeConfig.paddleSpeedWidthPercentS" class="form-input" min="0" step="0.1" value="50">
            </div>
            <p class="form-help-text">How fast paddles can move (s/width)</p>
          </div>
          
          <div class="form-col">
            <label for="paddleVelocityAngularTransmissionPercent" class="form-label">Angular Transmission (%)</label>
            <div class="form-number-container">
              <input type="number" id="paddleVelocityAngularTransmissionPercent" name="gameModeConfig.paddleVelocityAngularTransmissionPercent" class="form-input" min="0" step="1" value="20">
            </div>
            <p class="form-help-text">How much paddle movement affects ball angle</p>
          </div>
          
          <div class="form-col">
            <label for="paddleVelocitySpeedTransmissionPercent" class="form-label">Speed Transmission (%)</label>
            <div class="form-number-container">
              <input type="number" id="paddleVelocitySpeedTransmissionPercent" name="gameModeConfig.paddleVelocitySpeedTransmissionPercent" class="form-input" min="0" step="1" value="20">
            </div>
            <p class="form-help-text">How much paddle movement affects ball speed</p>
          </div>
          
          <div class="form-col">
            <label for="powerUpRadius" class="form-label">Power-up Radius</label>
            <div class="form-number-container">
              <input type="number" id="powerUpRadius" name="gameModeConfig.powerUpRadius" class="form-input" min="0" step="0.1" value="1">
            </div>
            <p class="form-help-text">Size of power-up items</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Type Selection -->
    <div class="form-card">
      <div class="form-card-header">
        <h2 class="form-section-title mb-0">Game Type</h2>
      </div>
      <div class="form-card-body">
        <div class="form-row mb-4">
          <div class="form-col">
            <div class="form-check">
              <input type="radio" id="timedGameMode" name="gameModeType" value="timedGame" class="form-check-input" checked>
              <label for="timedGameMode" class="form-check-label">Timed Game</label>
              <p class="form-help-text">Play for a specific duration. Winner has the highest score when time runs out.</p>
            </div>
          </div>
          <div class="form-col">
            <div class="form-check">
              <input type="radio" id="scoredGameMode" name="gameModeType" value="scoredGame" class="form-check-input">
              <label for="scoredGameMode" class="form-check-label">Scored Game</label>
              <p class="form-help-text">Play until a player reaches the target score.</p>
            </div>
          </div>
          <div class="form-col">
            <div class="form-check">
              <input type="radio" id="survivalGameMode" name="gameModeType" value="survivalGame" class="form-check-input">
              <label for="survivalGameMode" class="form-check-label">Survival Game</label>
              <p class="form-help-text">Last player standing wins. Supports elimination and arena shrinking.</p>
            </div>
          </div>
        </div>
        
        <!-- Timed Game Settings -->
        <div class="game-mode-settings" id="timedGameSettings">
          <h3 class="form-subsection-title">Timed Game Settings</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="durationS" class="form-label">Duration (seconds)</label>
              <div class="form-number-container">
                <input type="number" id="durationS" name="modifierNames.timedGame.durationS" class="form-input" min="10" step="10" value="180">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scored Game Settings -->
        <div class="game-mode-settings hidden" id="scoredGameSettings">
          <h3 class="form-subsection-title">Scored Game Settings</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="goalObjective" class="form-label">Goal Objective</label>
              <div class="form-number-container">
                <input type="number" id="goalObjective" name="modifierNames.scoredGame.goalObjective" class="form-input" min="1" step="1" value="5">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Survival Game Settings -->
        <div class="game-mode-settings hidden" id="survivalGameSettings">
          <h3 class="form-subsection-title">Survival Game Settings</h3>
          
          <!-- Elimination Settings -->
          <div class="mb-4">
            <h4 class="form-subsection-title text-sm">Elimination</h4>
            <div class="form-row">
              <div class="form-col">
                <label for="threshold" class="form-label">Lives (elimination threshold)</label>
                <div class="form-number-container">
                  <input type="number" id="threshold" name="modifierNames.elimination.threshold" class="form-input" min="1" step="1" value="3">
                </div>
                <p class="form-help-text">Number of goals before a player is eliminated</p>
              </div>
            </div>
          </div>
          
          <!-- Arena Shrink Settings -->
          <div class="mb-4">
            <h4 class="form-subsection-title text-sm">Arena Shrink</h4>
            <div class="form-row">
              <div class="form-col">
                <div class="form-check">
                  <input type="checkbox" id="enableArenaShrink" name="enableArenaShrink" class="form-check-input" checked>
                  <label for="enableArenaShrink" class="form-check-label">Enable Arena Shrinking</label>
                </div>
                <p class="form-help-text">Arena gradually shrinks during gameplay</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Power-Up Settings -->
    <div class="form-card">
      <div class="form-card-header">
        <h2 class="form-section-title mb-0">Power-Ups</h2>
      </div>
      <div class="form-card-body">
        <!-- Power-Up Selection -->
        <div class="mb-4">
          <h3 class="form-subsection-title">Available Power-Ups</h3>
          <p class="form-help-text mb-3">Select which power-ups will appear in the game</p>
          <div class="form-row">
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="speedBoostEnabled" name="powerUpEnabled.speedBoost" class="form-check-input powerup-toggle">
                <label for="speedBoostEnabled" class="form-check-label">Speed Boost</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="blinkingBallEnabled" name="powerUpEnabled.blinkingBall" class="form-check-input powerup-toggle">
                <label for="blinkingBallEnabled" class="form-check-label">Blinking Ball</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="shooterEnabled" name="powerUpEnabled.shooter" class="form-check-input powerup-toggle">
                <label for="shooterEnabled" class="form-check-label">Shooter</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="multiBallEnabled" name="powerUpEnabled.multiBall" class="form-check-input powerup-toggle">
                <label for="multiBallEnabled" class="form-check-label">Multi Ball</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="bumperEnabled" name="powerUpEnabled.bumper" class="form-check-input powerup-toggle">
                <label for="bumperEnabled" class="form-check-label">Bumper</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="portalsEnabled" name="powerUpEnabled.portals" class="form-check-input powerup-toggle">
                <label for="portalsEnabled" class="form-check-label">Portals</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="speedGateEnabled" name="powerUpEnabled.speedGate" class="form-check-input powerup-toggle">
                <label for="speedGateEnabled" class="form-check-label">Speed Gate</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="protectedPowerUpEnabled" name="powerUpEnabled.protectedPowerUp" class="form-check-input powerup-toggle">
                <label for="protectedPowerUpEnabled" class="form-check-label">Protected Power-Up</label>
              </div>
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="bumperShieldEnabled" name="powerUpEnabled.bumperShield" class="form-check-input powerup-toggle">
                <label for="bumperShieldEnabled" class="form-check-label">Bumper Shield</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Power-Up Configurations -->
        <div class="powerup-config hidden" id="speedBoostConfig">
          <h3 class="form-subsection-title">Speed Boost Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="speedBoost_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="speedBoost_spawnWeight" name="powerUpNames.speedBoost.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="speedBoost_durationS" class="form-label">Duration (seconds)</label>
              <input type="number" id="speedBoost_durationS" name="powerUpNames.speedBoost.durationS" class="form-input" min="0" step="0.1" value="3">
            </div>
            <div class="form-col">
              <label for="speedBoost_totalRampUpStrength" class="form-label">Boost Strength</label>
              <input type="number" id="speedBoost_totalRampUpStrength" name="powerUpNames.speedBoost.totalRampUpStrength" class="form-input" min="1" step="0.1" value="1.5">
            </div>
            <div class="form-col">
              <label for="speedBoost_rampUpFrequencyS" class="form-label">Ramp Up Frequency (seconds)</label>
              <input type="number" id="speedBoost_rampUpFrequencyS" name="powerUpNames.speedBoost.rampUpFrequencyS" class="form-input" min="0" step="0.1" value="0.5">
            </div>
            <div class="form-col">
              <div class="form-check">
                <input type="checkbox" id="speedBoost_selfActivation" name="powerUpNames.speedBoost.selfActivation" class="form-check-input">
                <label for="speedBoost_selfActivation" class="form-check-label">Self Activation</label>
              </div>
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="blinkingBallConfig">
          <h3 class="form-subsection-title">Blinking Ball Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="blinkingBall_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="blinkingBall_spawnWeight" name="powerUpNames.blinkingBall.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="blinkingBall_durationS" class="form-label">Duration (seconds)</label>
              <input type="number" id="blinkingBall_durationS" name="powerUpNames.blinkingBall.durationS" class="form-input" min="0" step="0.1" value="3">
            </div>
            <div class="form-col">
              <label for="blinkingBall_blinkIntervalS" class="form-label">Blink Interval (seconds)</label>
              <input type="number" id="blinkingBall_blinkIntervalS" name="powerUpNames.blinkingBall.blinkIntervalS" class="form-input" min="0" step="0.1" value="0.5">
            </div>
            <div class="form-col">
              <label for="blinkingBall_blinkDurationS" class="form-label">Blink Duration (seconds)</label>
              <input type="number" id="blinkingBall_blinkDurationS" name="powerUpNames.blinkingBall.blinkDurationS" class="form-input" min="0" step="0.1" value="0.2">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="shooterConfig">
          <h3 class="form-subsection-title">Shooter Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="shooter_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="shooter_spawnWeight" name="powerUpNames.shooter.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="shooter_durationS" class="form-label">Duration (seconds)</label>
              <input type="number" id="shooter_durationS" name="powerUpNames.shooter.durationS" class="form-input" min="0" step="0.1" value="3">
            </div>
            <div class="form-col">
              <label for="shooter_chargeDurationS" class="form-label">Charge Duration (seconds)</label>
              <input type="number" id="shooter_chargeDurationS" name="powerUpNames.shooter.chargeDurationS" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="shooter_chargeRadiusS" class="form-label">Charge Radius</label>
              <input type="number" id="shooter_chargeRadiusS" name="powerUpNames.shooter.chargeRadiusS" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="shooter_shootAdditionalVelocityS" class="form-label">Additional Velocity</label>
              <input type="number" id="shooter_shootAdditionalVelocityS" name="powerUpNames.shooter.shootAdditionalVelocityS" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="shooter_playerSamplerStrategyName" class="form-label">Player Sampler Strategy</label>
              <input type="text" id="shooter_playerSamplerStrategyName" name="powerUpNames.shooter.playerSamplerStrategyName" class="form-input" value="default">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="multiBallConfig">
          <h3 class="form-subsection-title">Multi Ball Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="multiBall_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="multiBall_spawnWeight" name="powerUpNames.multiBall.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="multiBall_ballCount" class="form-label">Ball Count</label>
              <input type="number" id="multiBall_ballCount" name="powerUpNames.multiBall.ballCount" class="form-input" min="1" step="1" value="3">
            </div>
            <div class="form-col">
              <label for="multiBall_spreadAngleDegrees" class="form-label">Spread Angle (degrees)</label>
              <input type="number" id="multiBall_spreadAngleDegrees" name="powerUpNames.multiBall.spreadAngleDegrees" class="form-input" min="0" step="1" value="45">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="bumperConfig">
          <h3 class="form-subsection-title">Bumper Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="bumper_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="bumper_spawnWeight" name="powerUpNames.bumper.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="bumper_durationS" class="form-label">Duration (seconds)</label>
              <input type="number" id="bumper_durationS" name="powerUpNames.bumper.durationS" class="form-input" min="0" step="0.1" value="5">
            </div>
            <div class="form-col">
              <label for="bumper_bumperVelocityFactor" class="form-label">Velocity Factor</label>
              <input type="number" id="bumper_bumperVelocityFactor" name="powerUpNames.bumper.bumperVelocityFactor" class="form-input" min="0" step="0.1" value="1.2">
            </div>
            <div class="form-col">
              <label for="bumper_bumperMaxVelocityFactor" class="form-label">Max Velocity Factor</label>
              <input type="number" id="bumper_bumperMaxVelocityFactor" name="powerUpNames.bumper.bumperMaxVelocityFactor" class="form-input" min="0" step="0.1" value="2">
            </div>
            <div class="form-col">
              <label for="bumper_bumperAcceleration" class="form-label">Acceleration</label>
              <input type="number" id="bumper_bumperAcceleration" name="powerUpNames.bumper.bumperAcceleration" class="form-input" min="0" step="0.1" value="0.5">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="portalsConfig">
          <h3 class="form-subsection-title">Portals Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="portals_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="portals_spawnWeight" name="powerUpNames.portals.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="portals_durationS" class="form-label">Duration (seconds)</label>
              <input type="number" id="portals_durationS" name="powerUpNames.portals.durationS" class="form-input" min="0" step="0.1" value="5">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="speedGateConfig">
          <h3 class="form-subsection-title">Speed Gate Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="speedGate_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="speedGate_spawnWeight" name="powerUpNames.speedGate.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="speedGate_durationS" class="form-label">Duration (seconds)</label>
              <input type="number" id="speedGate_durationS" name="powerUpNames.speedGate.durationS" class="form-input" min="0" step="0.1" value="5">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="protectedPowerUpConfig">
          <h3 class="form-subsection-title">Protected Power-Up Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="protectedPowerUp_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="protectedPowerUp_spawnWeight" name="powerUpNames.protectedPowerUp.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="protectedPowerUp_powerUpName" class="form-label">Power-Up Name</label>
              <input type="text" id="protectedPowerUp_powerUpName" name="powerUpNames.protectedPowerUp.powerUpName" class="form-input" value="default">
            </div>
          </div>
        </div>

        <div class="powerup-config hidden" id="bumperShieldConfig">
          <h3 class="form-subsection-title">Bumper Shield Configuration</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="bumperShield_spawnWeight" class="form-label">Spawn Weight</label>
              <input type="number" id="bumperShield_spawnWeight" name="powerUpNames.bumperShield.spawnWeight" class="form-input" min="0" step="0.1" value="1">
            </div>
            <div class="form-col">
              <label for="bumperShield_speedMultiplier" class="form-label">Speed Multiplier</label>
              <input type="number" id="bumperShield_speedMultiplier" name="powerUpNames.bumperShield.speedMultiplier" class="form-input" min="0" step="0.1" value="1.5">
            </div>
            <div class="form-col">
              <label for="bumperShield_wallsHitThresold" class="form-label">Walls Hit Threshold</label>
              <input type="number" id="bumperShield_wallsHitThresold" name="powerUpNames.bumperShield.wallsHitThresold" class="form-input" min="0" step="1" value="3">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Goal Reset -->
    <div class="form-card">
      <div class="form-card-header">
        <h2 class="form-section-title mb-0">Additional Settings</h2>
      </div>
      <div class="form-card-body">
        <div class="mb-4">
          <h3 class="form-subsection-title">Goal Reset</h3>
          <div class="form-row">
            <div class="form-col">
              <label for="goalResetDelayS" class="form-label">Delay After Goal (seconds)</label>
              <div class="form-number-container">
                <input type="number" id="goalResetDelayS" name="modifierNames.goalReset.delayS" class="form-input" min="0" step="0.1" value="1">
              </div>
              <p class="form-help-text">Time to wait before resetting after a goal</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-6">
      {{#> components/button type="submit" variant="primary" class="w-full py-3"}}
        Create Lobby
      {{/components/button}}
    </div>
  </form>
</div>

<style>
  .hidden {
    display: none;
  }
  
  .form-subsection-title {
    @apply font-medium text-fg;
  }
  
  .text-sm {
    @apply text-sm;
  }
</style>

<script>
  document.addEventListener('contentLoaded', function() {
    // Game mode toggle functionality
    const gameModeRadios = document.querySelectorAll('input[name="gameModeType"]');
    
    gameModeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        // Hide all game mode settings
        document.querySelectorAll('.game-mode-settings').forEach(section => {
          section.classList.add('hidden');
        });
        
        // Show the selected game mode settings
        const selectedSettings = document.getElementById(`${this.value}Settings`);
        if (selectedSettings) {
          selectedSettings.classList.remove('hidden');
        }
      });
    });
    
    // Power-up toggle functionality
    const powerupToggles = document.querySelectorAll('.powerup-toggle');
    
    powerupToggles.forEach(toggle => {
      toggle.addEventListener('change', function() {
        const configSection = document.getElementById(`${this.id.replace('Enabled', '')}Config`);
        if (configSection) {
          configSection.classList.toggle('hidden', !this.checked);
        }
      });

      // Initialize visibility on page load
      const configSection = document.getElementById(`${toggle.id.replace('Enabled', '')}Config`);
      if (configSection) {
        configSection.classList.toggle('hidden', !toggle.checked);
      }
    });
  });

  function handleFormSubmit(event) {
    event.preventDefault();
    
    // Get the form element
    const form = event.target;
    const formData = new FormData(form);
    
    // Get the selected game mode type
    const selectedGameModeType = document.querySelector('input[name="gameModeType"]:checked').value;
    
    // Initialize the base game settings object with all required fields
    const gameSettings = {
      gameName: formData.get('gameName'),
      gameModeName: formData.get('gameModeName'),
      playerCount: Number(formData.get('playerCount')),
      gameModeConfig: {
        powerUpCapacities: {}
      },
      modifierNames: {
        powerUpSpawner: {
          meanDelayS: Number(formData.get('modifierNames.powerUpSpawner.meanDelayS')) || 5,
          delaySpanS: Number(formData.get('modifierNames.powerUpSpawner.delaySpanS')) || 2,
          positionSamplerStrategyName: formData.get('modifierNames.powerUpSpawner.positionSamplerStrategyName') || "uniformArena"
        },
        goalReset: {},
        paceBreaker: {
          noResetThresholdS: 10,
        noPaddleBounceThreshold: 10,
        twoPaddlesBounceThreshold: 7,
      onePaddleBounceThreshold: 14
        }
      },
      powerUpNames: {
      }
    };
    
    // Add specific game mode settings
    if (selectedGameModeType === 'timedGame') {
      gameSettings.modifierNames.timedGame = {};
    } else if (selectedGameModeType === 'scoredGame') {
      gameSettings.modifierNames.scoredGame = {};
    } else if (selectedGameModeType === 'survivalGame') {
      gameSettings.modifierNames.survivalGame = [];
      gameSettings.modifierNames.elimination = {};
      
      // Only include arenaShrink if checkbox is checked
      if (formData.get('enableArenaShrink')) {
        gameSettings.modifierNames.arenaShrink = [];
      }
    }
    
    // Handle power-ups
    const speedBoostEnabled = document.getElementById('speedBoostEnabled').checked;
    
    if (speedBoostEnabled) {
      gameSettings.powerUpNames.speedBoost = {};
      gameSettings.gameModeConfig.powerUpCapacities = {
        speedBoost: Number(formData.get('gameModeConfig.powerUpCapacities.speedBoost')) || 1.5
      };
    }
    
    // Process form fields to build the nested structure
    for (const [key, value] of formData.entries()) {
      // Skip special fields we've already handled
      if (key === 'gameName' || key === 'gameModeName' || key === 'playerCount' || 
          key === 'gameModeType' || key === 'enableArenaShrink' ||
          key.startsWith('powerUpEnabled')) {
        continue;
      }
      
      // Skip fields for non-selected game modes
      if ((key.startsWith('modifierNames.timedGame') && selectedGameModeType !== 'timedGame') ||
          (key.startsWith('modifierNames.scoredGame') && selectedGameModeType !== 'scoredGame') ||
          (key.startsWith('modifierNames.survivalGame') || key.startsWith('modifierNames.elimination')) && 
            selectedGameModeType !== 'survivalGame' ||
          (key.startsWith('modifierNames.arenaShrink') && 
            (selectedGameModeType !== 'survivalGame' || !formData.get('enableArenaShrink')))) {
        continue;
      }
      
      // Skip power-up configuration if power-up is not enabled
      if (key.startsWith('powerUpNames.speedBoost') && !speedBoostEnabled) {
        continue;
      }
      
      // Process nested path
      if (key.includes('.')) {
        const parts = key.split('.');
        let current = gameSettings;
        
        // Navigate the path and create objects as needed
        for (let i = 0; i < parts.length - 1; i++) {
          const part = parts[i];
          
          // Skip if we're already at a non-object
          if (typeof current !== 'object' || current === null) {
            break;
          }
          
          // Create the path if it doesn't exist
          if (!(part in current)) {
            current[part] = isNaN(Number(parts[i + 1])) ? {} : [];
          }
          
          current = current[part];
        }
        
        // Set the value if we have a valid path
        if (typeof current === 'object' && current !== null) {
          const lastKey = parts[parts.length - 1];
          
          // Convert values to appropriate types
          if (value === 'true') {
            current[lastKey] = true;
          } else if (value === 'false') {
            current[lastKey] = false;
          } else if (!isNaN(value) && value !== '') {
            current[lastKey] = Number(value);
          } else {
            current[lastKey] = value;
          }
        }
      }
    }
    
    console.log('Game settings:', gameSettings);
    
    // Send the data
    fetch('/games/lobby/new', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(gameSettings)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => {
          throw new Error(err.message || 'Network response was not ok');
        });
      }
      return response.json();
    })
    .then(data => {
      // Redirect to the new lobby or show success message
      window.location.href = `/games/lobby/join/${data.lobbyId}`;
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error creating lobby: ' + error.message);
    });
    
    return false;
  }
</script>