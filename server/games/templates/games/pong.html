<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiplayer Pong</title>
    <style>
      canvas {
        background: black;
        display: block;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>
    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = 600;
      canvas.height = 600;

      const socket = new WebSocket("ws://localhost:8000/ws/game/");

      socket.onopen = function () {
        console.log("âœ… WebSocket connected");
        socket.send(
          JSON.stringify({
            game: "pong",
            game_mode: "multiplayer_pong",
            modifiers: [],
            start_game: true,
          })
        );
      };

      let gameState = {};
      let lastUpdateTime = performance.now();

      socket.onmessage = (event) => {
        gameState = JSON.parse(event.data);
        lastUpdateTime = performance.now();
      };

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!gameState.ball) return;

        // Draw ball
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(gameState.ball.x * 6, gameState.ball.y * 6, 5, 0, Math.PI * 2);
        ctx.fill();

        // Draw paddles
        gameState.player_paddles?.forEach((paddle) => {
          ctx.fillRect(
            paddle.x * 6 - paddle.width * 3,
            paddle.y * 6 - paddle.height * 3,
            paddle.width * 6,
            paddle.height * 6
          );
        });
      }

      function update() {
        let deltaTime = (performance.now() - lastUpdateTime) / 1000;
        if (gameState.ball) {
          gameState.ball.x +=
            gameState.ball.dx * gameState.ball.speed * deltaTime;
          gameState.ball.y +=
            gameState.ball.dy * gameState.ball.speed * deltaTime;
        }
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();
    </script>
  </body>
</html>
